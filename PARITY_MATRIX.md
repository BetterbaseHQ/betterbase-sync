# Go↔Rust Parity Matrix

Audit date: 2026-02-19  
Rust baseline: `2ab8886` (+ working-tree fixes in this pass)  
Go reference: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync`

Status values: `match`, `intentional-diff`, `bug`

| Contract | Go behavior | Rust behavior | Parity status | Evidence (test/file refs) | Decision |
|---|---|---|---|---|---|
| `server/wsconn.go` + `server/rpcconn.go` auth-first WS handshake | Requires first frame auth within timeout; closes on timeout/non-auth first frame | Same auth-first + timeout close behavior | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/wsconn_test.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/ws_protocol_test.go`; Rust: `crates/api/src/ws/tests.rs` (`websocket_auth_timeout_closes_with_auth_failed`, `websocket_non_auth_first_frame_closes_with_auth_failed`) | Keep |
| WS protocol guards (subprotocol, malformed CBOR/frame types) | Enforces `less-rpc-v1`; malformed payloads close with protocol/auth errors; unknown notification ignored | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/ws_protocol_test.go`; Rust: `crates/api/src/ws/tests.rs`, `crates/realtime/src/ws/protocol.rs` tests | Keep |
| Broker backpressure / slow-consumer handling | Slow/closed subscribers are evicted from fanout paths | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/wsconn_test.go`; Rust: `crates/realtime/src/broker/multi.rs` (`broadcast_evicts_closed_or_slow_subscribers`) | Keep |
| Federation WS auth + trust + connection quota | HTTP signature auth, trusted-peer gate, per-peer connection quota/close behavior | Same externally visible behavior (status/close semantics) | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_ws.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_ws_test.go`; Rust: `crates/api/src/ws/mod.rs`, `crates/api/src/ws/tests.rs` (`websocket_federation_route_*`, `websocket_federation_route_enforces_connection_quota`) | Keep |
| Federation quota semantics (connections, subscribe-space caps, push record/byte, invitation quota) | Quotas enforced with release on unsubscribe/disconnect | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_quotas_test.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_protocol_test.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_push_test.go`; Rust: `crates/api/src/federation_quota.rs` tests, `crates/api/src/ws/tests.rs` (`websocket_federation_*quota*`) | Keep |
| JWT/JWKS validation contracts | Multi-issuer validation, audience checks, JWKS refresh/rotation handling | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/jwt_test.go`; Rust: `crates/auth/src/jwt/validator.rs` tests | Keep |
| UCAN validation contracts | Depth/attenuation/resource/audience/revocation enforcement | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/ucan_test.go`; Rust: `crates/auth/src/ucan.rs` tests | Keep |
| did:key encode/decode contracts | Decode known vector, reject invalid input, roundtrip/random key cases | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/didkey_test.go`; Rust: `crates/auth/src/did_key.rs` tests | Keep |
| Session token behavior | Signed session token roundtrip, expiry/version/tamper checks, read/write permission handling | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/session_test.go`; Rust: `crates/auth/src/session.rs` tests | Keep |
| HTTP signature verification contracts | RFC9421 subset, keyid/domain extraction, max-age checks, tamper detection | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/httpsig.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/httpsig_test.go`; Rust: `crates/auth/src/http_signature.rs` tests | Keep |
| Federation subscribe token (FST) behavior | Token issue/verify, expiry cap to UCAN, peer binding, dual-key verification | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/federation_token_test.go`; Rust: `crates/auth/src/federation_token.rs` tests | Keep |
| Inbound federation key lookup model | Dynamically resolves peer signing keys via peer JWKS client cache by keyid URL | Uses explicit configured `FEDERATION_TRUSTED_KEYS` map (no runtime fetch) | `intentional-diff` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_ws.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/auth/federation_jwks.go`; Rust: `crates/api/src/federation.rs`, `crates/app/src/federation.rs` | Keep explicit trust-key configuration for deterministic trust boundaries |
| Postgres migration compatibility (shared core schema) | Migrations `001`–`011` define server/storage schema | Same `001`–`011` present | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/storage/migrations`; Rust: `crates/storage/migrations/001_initial.sql` … `crates/storage/migrations/011_federation_keys.sql` | Keep |
| Postgres migration lifecycle extension | No explicit active/primary lifecycle migration beyond `011` | Adds `012_federation_key_lifecycle.sql` for explicit key activation/promotion state | `intentional-diff` | Rust: `crates/storage/migrations/012_federation_key_lifecycle.sql`; tests: `crates/storage/src/postgres.rs` (`federation_keys_rotation_keeps_overlap_window_and_promotes_new_primary`) | Keep (correctness/operability improvement) |
| Storage push conflict/tombstone/idempotency semantics | Push conflict handling, delete/tombstone behavior, idempotent file metadata flows | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/storage/postgres_test.go`; Rust: `crates/storage/src/postgres.rs` tests (`push_*`, `record_file_*`, `delete_files_for_records_*`) | Keep |
| Unified pull cursor ordering | Ordered pull stream across record/member/file timeline | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/storage/postgres_test.go` (`TestPostgres_Pull_OrderBySequenceThenID`); Rust: `crates/storage/src/postgres.rs` (`stream_pull_returns_unified_ordered_entries`) | Keep |
| Revocation and invitation semantics | UCAN revocation persistence; invitation mailbox scoping and pagination/expiry | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/storage/postgres_test.go`; Rust: `crates/storage/src/postgres.rs` (`revoke_ucan_roundtrip_and_space_isolation`, `invitation_crud_and_mailbox_scope`, `list_invitations_*`) | Keep |
| Epoch/DEK/file-DEK invariants | Epoch advance/complete + DEK/rewrap mismatch checks and file DEK flows | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/storage/postgres_test.go` (`AdvanceEpoch`, `CompleteRewrap`, `RewrapDEKs`, `RewrapFileDEKs`); Rust: `crates/storage/src/postgres.rs` tests (`advance_epoch_*`, `complete_rewrap_*`, `get_deks_and_rewrap_deks_epoch_validation`, `rewrap_file_deks_*`) | Keep |
| HTTP auth middleware contracts | Public route bypasses (`/health`, WS, JWKS, federation WS); bearer token required elsewhere | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/middleware.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/server_test.go`; Rust: `crates/api/src/lib.rs` (`is_public_route`, middleware tests) | Keep |
| `X-UCAN` passthrough size bound | Rejects `X-UCAN` header > 64 KiB | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/middleware.go` (`maxUCANHeaderSize`); Rust: `crates/api/src/lib.rs` (`MAX_UCAN_HEADER_SIZE`, `auth_middleware_rejects_oversized_ucan_header`) | Keep |
| Global HTTP headers/CORS contracts | Adds CORS headers + `X-Protocol-Version: 1`; handles OPTIONS preflight | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/server.go` (`corsMiddleware`); Rust: `crates/api/src/lib.rs` (`cors_and_protocol_middleware`, tests) | Keep |
| `/health` payload contract | JSON health payload, DB liveness check, federation summary counts when enabled | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/server.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_http.go`; Rust: `crates/api/src/lib.rs` (`health`, health tests) | Keep |
| Federation HTTP metadata/status contracts | JWKS public route + cache-control; trusted/status endpoints auth-gated and peer-filtered | Same visible status/payload behavior | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_http.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/federation_jwks.go`, tests in `server/federation_http_test.go`; Rust: `crates/api/src/federation_http.rs`, tests in `crates/api/src/lib.rs` | Keep |
| HTTP file route wiring and authz contracts | File routes enabled only with file backend; scope + personal/shared UCAN authz + idempotent PUT | Same | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/server.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/files.go`, `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/server/files_test.go`; Rust: `crates/api/src/lib.rs`, `crates/api/src/files.rs` tests | Keep |
| Server env/config parsing (issuers/audiences/file/federation knobs) | Parses trusted issuers/audiences and federation/file envs at startup | Same core parsing behavior | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/cmd/server/main.go`; Rust: `crates/app/src/lib.rs` tests, `crates/app/src/federation.rs` tests | Keep |
| Default server bind address | Default `:5379` (all interfaces) | Default `0.0.0.0:5379` (all interfaces) | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/cmd/server/main.go`; Rust: `crates/app/src/lib.rs` | Keep |
| Migration CLI command surface | Supports `up`, `down`, `status`, `version`, `create` | Supports `up` only (`less-sync-migrate`) | `intentional-diff` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/cmd/migrate/main.go`; Rust: `bins/migrate/src/main.rs` | Keep for now; expand CLI surface in Phase 7 tooling pass |
| Server perf/debug runtime knobs | Supports `-perf-mode`, `MAX_RECORD_BLOB_SIZE`, `MAX_FILE_SIZE`, optional pprof server | Not yet surfaced in Rust runtime binary | `intentional-diff` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/cmd/server/main.go`; Rust: `bins/server/src/main.rs`, `crates/app/src/lib.rs` | Keep for now; treat as Phase 7 parity backlog |
| Federation keygen CLI behavior | Generates/stores Ed25519 federation keys in DB | Same + explicit `--domain` keyid construction + `--no-promote` staged rollover | `match` | Go: `/Users/nchapman/Code/lessisbetter/less-platform/less-sync/cmd/federation-keygen/main.go`; Rust: `bins/federation-keygen/src/main.rs` tests | Keep |

## Findings

No open `bug` rows in this audit pass.

All newly identified differences are documented as explicit `intentional-diff` items and tied to follow-up scope where needed.
